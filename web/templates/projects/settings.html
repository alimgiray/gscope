{{define "project_settings"}} {{template "header" .}}

<div class="card">
  <div class="card-header">Project Settings - {{.Project.Name}}</div>

  <!-- Project Name Form -->
  <div class="mb-6">
    <h4 class="text-green-400 mb-3 text-sm font-semibold">Project Name</h4>
    <form
      method="POST"
      action="/projects/{{.Project.ID}}/settings/name"
      class="flex gap-3"
    >
      <input
        type="text"
        name="name"
        value="{{.Project.Name}}"
        class="form-control flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
        required
      />
      <button
        type="submit"
        class="btn btn-primary bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200"
      >
        Update Name
      </button>
    </form>
  </div>

  <!-- Score Settings Form -->
  <div class="mb-6">
    <h4 class="text-green-400 mb-3 text-sm font-semibold">Score Settings</h4>
    <form method="POST" action="/projects/{{.Project.ID}}/settings/scores">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-xs text-gray-300 mb-1 block">Additions</label>
          <input
            type="number"
            name="additions"
            value="{{.ScoreSettings.Additions}}"
            min="0"
            class="form-control bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
            required
          />
        </div>
        <div>
          <label class="text-xs text-gray-300 mb-1 block">Deletions</label>
          <input
            type="number"
            name="deletions"
            value="{{.ScoreSettings.Deletions}}"
            min="0"
            class="form-control bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
            required
          />
        </div>
        <div>
          <label class="text-xs text-gray-300 mb-1 block">Commits</label>
          <input
            type="number"
            name="commits"
            value="{{.ScoreSettings.Commits}}"
            min="0"
            class="form-control bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
            required
          />
        </div>
        <div>
          <label class="text-xs text-gray-300 mb-1 block">Pull Requests</label>
          <input
            type="number"
            name="pull_requests"
            value="{{.ScoreSettings.PullRequests}}"
            min="0"
            class="form-control bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
            required
          />
        </div>
        <div>
          <label class="text-xs text-gray-300 mb-1 block">Comments</label>
          <input
            type="number"
            name="comments"
            value="{{.ScoreSettings.Comments}}"
            min="0"
            class="form-control bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
            required
          />
        </div>
      </div>
      <button
        type="submit"
        class="btn btn-primary bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200 mt-3"
      >
        Update Scores
      </button>
    </form>
  </div>

  <!-- Excluded Extensions -->
  <div class="mb-6">
    <h4 class="text-green-400 mb-3 text-sm font-semibold">
      Excluded Extensions
    </h4>

    <!-- Add Extension Form -->
    <form
      method="POST"
      action="/projects/{{.Project.ID}}/settings/extensions"
      class="flex gap-3 mb-3"
    >
      <input
        type="text"
        name="extension"
        placeholder="e.g., exe, dll, min.js"
        class="form-control flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
        required
      />
      <button
        type="submit"
        class="btn btn-primary bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200"
      >
        Add Extension
      </button>
    </form>

    <!-- Current Extensions -->
    {{if .ExcludedExtensions}}
    <div class="space-y-2">
      {{range .ExcludedExtensions}}
      <div
        class="flex justify-between items-center p-3 border border-gray-600 rounded-lg bg-gray-800 bg-opacity-50"
      >
        <span class="text-sm font-mono text-white">{{.Extension}}</span>
        <form
          method="POST"
          action="/projects/{{$.Project.ID}}/settings/extensions/{{.ID}}/delete"
          class="inline"
        >
          <button
            type="submit"
            class="text-red-400 hover:text-red-300 text-sm bg-red-600 hover:bg-red-500 px-3 py-1 rounded transition-colors duration-200"
          >
            Delete
          </button>
        </form>
      </div>
      {{end}}
    </div>
    {{else}}
    <p class="text-xs text-gray-400">No excluded extensions configured.</p>
    {{end}}
  </div>

  <!-- Excluded Folders -->
  <div class="mb-6">
    <h4 class="text-green-400 mb-3 text-sm font-semibold">Excluded Folders</h4>

    <!-- Add Folder Form -->
    <form
      method="POST"
      action="/projects/{{.Project.ID}}/settings/folders"
      class="flex gap-3 mb-3"
    >
      <input
        type="text"
        name="folder_path"
        placeholder="e.g., node_modules, dist, build"
        class="form-control flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
        required
      />
      <button
        type="submit"
        class="btn btn-primary bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200"
      >
        Add Folder
      </button>
    </form>

    <!-- Current Folders -->
    {{if .ExcludedFolders}}
    <div class="space-y-2">
      {{range .ExcludedFolders}}
      <div
        class="flex justify-between items-center p-3 border border-gray-600 rounded-lg bg-gray-800 bg-opacity-50"
      >
        <span class="text-sm font-mono text-white">{{.FolderPath}}</span>
        <form
          method="POST"
          action="/projects/{{$.Project.ID}}/settings/folders/{{.ID}}/delete"
          class="inline"
        >
          <button
            type="submit"
            class="text-red-400 hover:text-red-300 text-sm bg-red-600 hover:bg-red-500 px-3 py-1 rounded transition-colors duration-200"
          >
            Delete
          </button>
        </form>
      </div>
      {{end}}
    </div>
    {{else}}
    <p class="text-xs text-gray-400">No excluded folders configured.</p>
    {{end}}
  </div>

  <!-- Auto Update Settings -->
  <div class="mb-6">
    <h4 class="text-green-400 mb-3 text-sm font-semibold">Automatic Updates</h4>
    <p class="text-xs text-gray-400 mb-3">
      Configure automatic daily updates for this project.
    </p>

    <form
      method="POST"
      action="/projects/{{.Project.ID}}/settings/update-settings"
    >
      <div class="flex items-center gap-4 mb-3">
        <label class="flex items-center gap-2">
          <input
            type="checkbox"
            name="auto_update_enabled"
            {{if
            and
            .UpdateSettings
            .UpdateSettings.IsEnabled}}checked{{end}}
            class="rounded"
          />
          <span class="text-xs text-gray-300">Enable automatic updates</span>
        </label>
      </div>

      <div class="flex items-center gap-3">
        <label class="text-xs text-gray-300">Update time (hour):</label>
        <input
          type="number"
          name="auto_update_hour"
          value="{{if .UpdateSettings}}{{.UpdateSettings.Hour}}{{else}}0{{end}}"
          min="0"
          max="23"
          class="form-control w-20 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
          required
        />
        <span class="text-xs text-gray-400">(0-23, 24-hour format)</span>
      </div>

      <button
        type="submit"
        class="btn btn-primary bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200 mt-3"
      >
        Save Update Settings
      </button>
    </form>
  </div>

  <!-- Working Hours Settings -->
  <div class="mb-6">
    <h4 class="text-green-400 mb-3 text-sm font-semibold">
      Working Hours Settings
    </h4>
    <p class="text-xs text-gray-400 mb-3">
      Configure working hours and days for overtime calculations.
    </p>

    <form
      method="POST"
      action="/projects/{{.Project.ID}}/working-hours-settings"
    >
      <!-- Working Hours -->
      <div class="mb-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="start_hour" class="block text-xs text-gray-300 mb-1"
              >Start Hour</label
            >
            <select
              name="start_hour"
              id="start_hour"
              class="form-control bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
            >
              {{range $hour := seq 0 23}}
              <option
                value="{{$hour}}"
                {{if
                eq
                $hour
                $.WorkingHoursSettings.StartHour}}selected{{end}}
              >
                {{printf "%02d:00" $hour}}
              </option>
              {{end}}
            </select>
          </div>
          <div>
            <label for="end_hour" class="block text-xs text-gray-300 mb-1"
              >End Hour</label
            >
            <select
              name="end_hour"
              id="end_hour"
              class="form-control bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
            >
              {{range $hour := seq 0 23}}
              <option
                value="{{$hour}}"
                {{if
                eq
                $hour
                $.WorkingHoursSettings.EndHour}}selected{{end}}
              >
                {{printf "%02d:00" $hour}}
              </option>
              {{end}}
            </select>
          </div>
        </div>
      </div>

      <!-- Working Days -->
      <div class="mb-4">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="flex items-center">
            <input
              type="checkbox"
              name="monday"
              id="monday"
              class="w-4 h-4 text-green-600 bg-gray-800 border-gray-600 rounded"
              {{if
              $.WorkingHoursSettings.Monday}}checked{{end}}
            />
            <label for="monday" class="ml-2 text-xs text-gray-300"
              >Monday</label
            >
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              name="tuesday"
              id="tuesday"
              class="w-4 h-4 text-green-600 bg-gray-800 border-gray-600 rounded"
              {{if
              $.WorkingHoursSettings.Tuesday}}checked{{end}}
            />
            <label for="tuesday" class="ml-2 text-xs text-gray-300"
              >Tuesday</label
            >
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              name="wednesday"
              id="wednesday"
              class="w-4 h-4 text-green-600 bg-gray-800 border-gray-600 rounded"
              {{if
              $.WorkingHoursSettings.Wednesday}}checked{{end}}
            />
            <label for="wednesday" class="ml-2 text-xs text-gray-300"
              >Wednesday</label
            >
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              name="thursday"
              id="thursday"
              class="w-4 h-4 text-green-600 bg-gray-800 border-gray-600 rounded"
              {{if
              $.WorkingHoursSettings.Thursday}}checked{{end}}
            />
            <label for="thursday" class="ml-2 text-xs text-gray-300"
              >Thursday</label
            >
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              name="friday"
              id="friday"
              class="w-4 h-4 text-green-600 bg-gray-800 border-gray-600 rounded"
              {{if
              $.WorkingHoursSettings.Friday}}checked{{end}}
            />
            <label for="friday" class="ml-2 text-xs text-gray-300"
              >Friday</label
            >
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              name="saturday"
              id="saturday"
              class="w-4 h-4 text-green-600 bg-gray-800 border-gray-600 rounded"
              {{if
              $.WorkingHoursSettings.Saturday}}checked{{end}}
            />
            <label for="saturday" class="ml-2 text-xs text-gray-300"
              >Saturday</label
            >
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              name="sunday"
              id="sunday"
              class="w-4 h-4 text-green-600 bg-gray-800 border-gray-600 rounded"
              {{if
              $.WorkingHoursSettings.Sunday}}checked{{end}}
            />
            <label for="sunday" class="ml-2 text-xs text-gray-300"
              >Sunday</label
            >
          </div>
        </div>
      </div>

      <!-- Info Box -->
      <div
        class="mb-4 p-3 bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg"
      >
        <p class="text-xs text-gray-300">
          These settings determine what constitutes "overtime" work. Any commits
          or comments made outside the specified working hours and days will be
          counted as overtime in the person statistics.
        </p>
      </div>

      <button
        type="submit"
        class="btn btn-primary bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200"
      >
        Save Working Hours Settings
      </button>
    </form>
  </div>

  <!-- AI Settings -->
  <div class="mb-6 border-t border-gray-600 pt-6">
    <h4 class="text-green-400 mb-3 text-sm font-semibold">AI Settings</h4>
    <p class="text-xs text-gray-400 mb-4">
      Configure AI features for this project. Only project owners can manage LLM
      API keys.
    </p>

    <!-- Current API Key Status -->
    {{if .APIKey}}
    <div
      class="p-4 border border-green-600 rounded-lg bg-green-900 bg-opacity-20 mb-4"
    >
      <div class="flex items-center gap-2 mb-3">
        <span class="text-green-400 text-xl">[OK]</span>
        <span class="text-green-400 font-semibold">AI Features Enabled</span>
      </div>

      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-300">Provider:</span>
          <span class="text-white font-mono"
            >{{.APIKey.GetDisplayProvider}}</span
          >
        </div>
        {{if eq .AccessType "owner"}}
        <div class="flex justify-between">
          <span class="text-gray-300">API Key:</span>
          <span class="text-white font-mono">{{.APIKey.MaskAPIKey}}</span>
        </div>
        {{end}}
        <div class="flex justify-between">
          <span class="text-gray-300">Status:</span>
          <span class="text-green-400 font-mono">Active</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-300">Last Updated:</span>
          <span class="text-white font-mono"
            >{{.APIKey.UpdatedAt.Format "2006-01-02 15:04:05"}}</span
          >
        </div>
      </div>

      {{if eq .AccessType "owner"}}
      <div class="flex gap-3 mt-4">
        <button
          onclick="showUpdateAIForm()"
          class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium"
        >
          Update API Key
        </button>
        <button
          onclick="deleteAIAPIKey()"
          class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium"
        >
          Remove API Key
        </button>
      </div>
      {{end}}
    </div>
    {{else}}
    <div
      class="p-4 border border-yellow-600 rounded-lg bg-yellow-900 bg-opacity-20 mb-4"
    >
      <div class="flex items-center gap-2 mb-3">
        <span class="text-yellow-400 text-xl">[!]</span>
        <span class="text-yellow-400 font-semibold">AI Features Disabled</span>
      </div>

      <div class="text-sm text-gray-300 mb-4">
        No LLM API key configured for this project. AI features like commit
        summaries and reviewer suggestions are currently unavailable.
      </div>

      {{if eq .AccessType "owner"}}
      <button
        onclick="showCreateAIForm()"
        class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium"
      >
        Configure API Key
      </button>
      {{else}}
      <div class="text-xs text-gray-500">
        Only project owners can configure LLM API keys.
      </div>
      {{end}}
    </div>
    {{end}}

    <!-- API Key Configuration Form (Hidden by default) -->
    {{if eq .AccessType "owner"}}
    <div
      id="ai-key-form"
      class="border border-gray-600 rounded-lg p-4 bg-gray-800 bg-opacity-50"
      style="display: none"
    >
      <div class="mb-4">
        <h5 id="ai-form-title" class="text-white font-semibold">
          Configure LLM API Key
        </h5>
      </div>
      <form id="ai-llm-form" onsubmit="submitAIAPIKey(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >Provider</label
            >
            <select
              name="provider"
              id="ai-provider"
              required
              class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="anthropic">Anthropic Claude</option>
            </select>
            <div class="text-xs text-gray-400 mt-1">
              Currently only Anthropic Claude is supported
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >API Key</label
            >
            <div class="relative">
              <input
                type="password"
                name="api_key"
                id="ai-api-key"
                required
                placeholder="sk-ant-..."
                class="w-full px-3 py-2 pr-12 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                type="button"
                onclick="toggleAIApiKeyVisibility()"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white focus:outline-none"
                title="Show/Hide API Key"
              >
                <span id="ai-eye-icon">Show</span>
              </button>
            </div>
            <div class="text-xs text-gray-400 mt-1">
              Your API key is stored securely and only visible to project owners
            </div>
          </div>

          <div
            class="bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg p-3"
          >
            <div class="text-blue-400 font-semibold mb-2 text-sm">
              Security & Privacy
            </div>
            <ul class="text-xs text-gray-300 space-y-1">
              <li>• API keys are stored in plaintext on the server</li>
              <li>
                • Only project owners can view, update, or delete API keys
              </li>
              <li>• Collaborators can only see if AI features are enabled</li>
              <li>• Keys are project-scoped and not shared between projects</li>
            </ul>
          </div>

          <div class="flex gap-3">
            <button
              type="submit"
              class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium"
            >
              <span id="ai-submit-text">Save API Key</span>
            </button>
            <button
              type="button"
              onclick="hideAIForm()"
              class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium"
            >
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
    {{end}}

    <!-- Available AI Features Info -->
    <div
      class="mt-4 p-3 bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg"
    >
      <div class="text-gray-300 font-semibold mb-2 text-sm">
        Available AI Features
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
        <div class="text-gray-300">• Commit Analysis</div>
        <div class="text-gray-300">• PR Summaries</div>
        <div class="text-gray-300">• Reviewer Suggestions</div>
        <div class="text-gray-300">• Insights Generation</div>
      </div>
      <div class="text-gray-400 text-xs mt-2">
        These features will be available once an LLM API key is configured.
      </div>
    </div>
  </div>

  <!-- Delete Project -->
  <div class="border-t border-gray-600 pt-6">
    <h4 class="text-red-400 mb-3 text-sm font-semibold">Danger Zone</h4>
    <p class="text-xs text-gray-400 mb-3">
      This action cannot be undone. All project data will be permanently
      deleted.
    </p>
    <form
      method="POST"
      action="/projects/{{.Project.ID}}/settings/delete"
      onsubmit="return confirm('Are you sure you want to delete this project? This action cannot be undone.')"
    >
      <button
        type="submit"
        class="btn bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded transition-colors duration-200"
      >
        Delete Project
      </button>
    </form>
  </div>
</div>

<script>
  function toggleAIApiKeyVisibility() {
    const apiKeyInput = document.getElementById("ai-api-key");
    const eyeIcon = document.getElementById("ai-eye-icon");

    if (apiKeyInput.type === "password") {
      apiKeyInput.type = "text";
      eyeIcon.textContent = "Hide";
    } else {
      apiKeyInput.type = "password";
      eyeIcon.textContent = "Show";
    }
  }

  function showCreateAIForm() {
    document.getElementById("ai-form-title").textContent =
      "Configure LLM API Key";
    document.getElementById("ai-submit-text").textContent = "Save API Key";
    document.getElementById("ai-api-key").value = "";
    document.getElementById("ai-key-form").style.display = "block";
    document.getElementById("ai-api-key").focus();
  }

  function showUpdateAIForm() {
    document.getElementById("ai-form-title").textContent = "Update LLM API Key";
    document.getElementById("ai-submit-text").textContent = "Update API Key";
    document.getElementById("ai-api-key").value = "";
    document.getElementById("ai-key-form").style.display = "block";
    document.getElementById("ai-api-key").focus();
  }

  function hideAIForm() {
    document.getElementById("ai-key-form").style.display = "none";
  }

  function submitAIAPIKey(event) {
    event.preventDefault();

    const form = document.getElementById("ai-llm-form");
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.querySelector("span").textContent;

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.querySelector("span").textContent = "Saving...";

    fetch(`/projects/{{.Project.ID}}/llm/api-key`, {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Reload page to show updated status
          window.location.reload();
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Failed to save API key");
      })
      .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.querySelector("span").textContent = originalText;
      });
  }

  function deleteAIAPIKey() {
    if (
      !confirm(
        "Are you sure you want to delete the LLM API key? This will disable all AI features for this project."
      )
    ) {
      return;
    }

    fetch(`/projects/{{.Project.ID}}/llm/api-key`, {
      method: "DELETE",
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Reload page to show updated status
          window.location.reload();
        } else {
          alert("Error: " + data.message);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Failed to delete API key");
      });
  }
</script>

{{template "footer" .}} {{end}}
