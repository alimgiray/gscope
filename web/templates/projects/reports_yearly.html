{{define "project_reports_yearly"}}
{{template "header" .}}

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<div class="card">
    <div class="flex justify-between items-center">
        <div class="card-header">{{.Project.Name}} - Yearly Reports</div>
        <a href="/projects/{{.Project.ID}}/reports" class="text-green-400 hover:text-green-300 text-xs">‚Üê Back to Reports</a>
    </div>
    {{if .Project.Description}}
    <p class="text-gray-300 mb-2">{{.Project.Description}}</p>
    {{end}}
    <div class="text-xs text-gray-400 mt-2">
        Yearly reports and analytics
    </div>
</div>

<!-- Year Selection -->
<div class="card mt-4">
    <div class="card-header">Select Year</div>
    <div class="card-body">
        <div class="flex gap-4 items-center">
            <form method="GET" id="yearForm" class="flex gap-4 items-center">
                <select name="year" id="yearSelect" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-green-400">
                    {{range .Years}}
                        <option value="{{.}}" {{if eq . $.SelectedYear}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </form>
            <button onclick="exportToExcel('{{.Project.ID}}', '{{.SelectedYear}}')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded text-xs transition-colors duration-200">
                üìä Export to Excel
            </button>
        </div>
    </div>
</div>

<script>
document.getElementById('yearSelect').addEventListener('change', function() {
    document.getElementById('yearForm').submit();
});

function exportToExcel(projectId, selectedYear) {
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'üìä Generating...';
    button.disabled = true;
    button.className = 'bg-yellow-600 text-white px-3 py-2 rounded text-xs cursor-not-allowed opacity-50';
    
    // Make the export request
    fetch(`/projects/${projectId}/reports/yearly/export?year=${selectedYear}`, {
        method: 'GET',
        headers: {
            'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.blob();
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `yearly-report-${selectedYear}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Show success message
        showToast('Excel file downloaded successfully!', 'success');
    })
    .catch(error => {
        console.error('Export error:', error);
        showToast('Failed to export Excel file', 'error');
    })
    .finally(() => {
        // Restore button state
        button.textContent = originalText;
        button.disabled = false;
        button.className = 'bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded text-xs transition-colors duration-200';
    });
}

// Toast functionality
function showToast(message, type = 'success') {
    // Create toast container if it doesn't exist
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'fixed top-4 right-4 z-50 space-y-2';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `p-3 rounded shadow-lg text-white text-sm max-w-sm transform transition-all duration-300 translate-x-full`;
    
    // Set background color based on type
    if (type === 'success') {
        toast.className += ' bg-green-500';
    } else if (type === 'error') {
        toast.className += ' bg-red-500';
    } else if (type === 'info') {
        toast.className += ' bg-blue-500';
    }

    toast.textContent = message;
    container.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);

    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (container.contains(toast)) {
                container.removeChild(toast);
            }
        }, 300);
    }, 3000);
}
</script>

<!-- Yearly Reports Content -->
<div class="card mt-4">
    <div class="card-header">Yearly Reports - {{.SelectedYear}}</div>
    <div class="card-body">
        {{if .YearlyStats}}
            <div class="space-y-4">
                {{range .YearlyStats}}
                <div class="p-4 border border-gray-600 rounded-lg bg-gray-800 bg-opacity-50">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-3">
                                <a href="/projects/{{$.Project.ID}}/people/{{.GitHubPerson.ID}}" class="text-lg font-semibold text-green-400 hover:text-green-300 transition-colors duration-200">{{.GitHubPerson.Username}}</a>
                                {{if .GitHubPerson.DisplayName}}
                                    <span class="text-sm text-gray-300">({{.GitHubPerson.DisplayName}})</span>
                                {{end}}
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm">
                                <div class="text-center p-3 bg-gray-700 rounded">
                                    <div class="text-2xl font-bold text-green-400">{{.TotalScore}}</div>
                                    <div class="text-xs text-gray-400">Score</div>
                                </div>
                                <div class="text-center p-3 bg-gray-700 rounded">
                                    <div class="text-lg font-semibold text-blue-400">{{.TotalCommits}}</div>
                                    <div class="text-xs text-gray-400">Commits</div>
                                </div>
                                <div class="text-center p-3 bg-gray-700 rounded">
                                    <div class="text-lg font-semibold text-green-400">{{.TotalAdditions}}</div>
                                    <div class="text-xs text-gray-400">Additions</div>
                                </div>
                                <div class="text-center p-3 bg-gray-700 rounded">
                                    <div class="text-lg font-semibold text-red-400">{{.TotalDeletions}}</div>
                                    <div class="text-xs text-gray-400">Deletions</div>
                                </div>
                                <div class="text-center p-3 bg-gray-700 rounded">
                                    <div class="text-lg font-semibold text-purple-400">{{.TotalPullRequests}}</div>
                                    <div class="text-xs text-gray-400">Pull Requests</div>
                                </div>
                                <div class="text-center p-3 bg-gray-700 rounded">
                                    <div class="text-lg font-semibold text-yellow-400">{{.TotalComments}}</div>
                                    <div class="text-xs text-gray-400">Comments</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
        {{else}}
            <p class="text-gray-400 text-sm">No statistics available for {{.SelectedYear}}.</p>
        {{end}}
    </div>
</div>

{{template "footer" .}}
{{end}} 