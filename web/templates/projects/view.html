{{define "project_view"}}
{{template "header" .}}

<div class="card">
    <div class="flex justify-between items-center">
        <div class="card-header">{{.Project.Name}}</div>
        <div class="flex gap-2">
            <a href="/projects/{{.Project.ID}}/collaborators" class="text-blue-400 hover:text-blue-300 text-xs">üë• Collaborators</a>
            <a href="/projects/{{.Project.ID}}/settings" class="text-green-400 hover:text-green-300 text-xs">‚öô Settings</a>
        </div>
    </div>
    {{if .Project.Description}}
    <p>{{.Project.Description}}</p>
    {{end}}
    <div class="text-xs text-gray-400 mt-2">
        <div>Owner: {{.Owner.Name}} (@{{.Owner.Username}})</div>
        <div>Created: {{.Project.CreatedAt.Format "2006-01-02 15:04:05"}}</div>
    </div>

    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    <div class="mt-4 flex gap-3">
        <form method="POST" action="/projects/{{.Project.ID}}/fetch-repositories" class="inline">
            <button type="submit" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" title="Import your GitHub repositories into this project">
                Fetch Repositories
            </button>
        </form>
        <button class="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" onclick="trackAllRepositories('{{.Project.ID}}')" title="Start tracking all repositories in this project">
            Track All
        </button>
        <button class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" onclick="cloneAllRepositories('{{.Project.ID}}')" title="Clone all repositories to local storage">
            Clone All
        </button>
        <button class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" onclick="fetchAllRepositories('{{.Project.ID}}')" title="Fetch latest data from GitHub for all repositories">
            Fetch Github All
        </button>
        <button class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" onclick="analyzeAllRepositories('{{.Project.ID}}')" title="Analyze all repositories for statistics">
            Analyze All
        </button>
        <button class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" onclick="updateAllRepositories('{{.Project.ID}}')" title="Update all repositories (fetch, analyze, etc.)">
            Update All
        </button>
        <a href="/projects/{{.Project.ID}}/emails" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" title="Manage and merge contributor emails">
            Emails
        </a>
        <a href="/projects/{{.Project.ID}}/people" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" title="View and associate GitHub users with emails">
            People
        </a>
        <a href="/projects/{{.Project.ID}}/reports" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded transition-colors duration-200 text-sm font-medium" title="View analytics and reports for this project">
            Reports
        </a>
    </div>
</div>

<!-- Help Section -->
<div class="card mt-4">
    <div class="card-header cursor-pointer" onclick="toggleHelpSection()" id="help-header">
        <div class="flex items-center justify-between">
            <span>üìö How GScope Works</span>
            <span id="help-toggle" class="text-gray-400">‚ñº</span>
        </div>
    </div>
    <div class="card-body hidden" id="help-content">
        <div class="space-y-4 text-sm text-gray-300">
            <div>
                <h4 class="font-semibold text-white mb-2">Getting Started with GScope</h4>
                <p class="mb-3">GScope analyzes your GitHub repositories to provide insights on commits, pull requests, contributors, and code statistics. Here's how to set it up:</p>
            </div>
            
            <div class="space-y-3">
                <div class="flex items-start gap-3">
                    <div class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">1</div>
                    <div>
                        <h5 class="font-semibold text-white">Fetch & Track Repositories</h5>
                        <p>Click "Fetch Repositories" to import your GitHub repositories, then use "Track All" to start monitoring them for analysis.</p>
                    </div>
                </div>
                
                <div class="flex items-start gap-3">
                    <div class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">2</div>
                    <div>
                        <h5 class="font-semibold text-white">Clone Repositories</h5>
                        <p>Use "Clone All" to download repositories to local storage. This is required for analyzing commit history and file changes.</p>
                    </div>
                </div>
                
                <div class="flex items-start gap-3">
                    <div class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">3</div>
                    <div>
                        <h5 class="font-semibold text-white">Fetch GitHub Data</h5>
                        <p>Use "Fetch Github All" to get the latest pull requests, reviews, and contributor information from GitHub.</p>
                    </div>
                </div>
                
                <div class="flex items-start gap-3">
                    <div class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">4</div>
                    <div>
                        <h5 class="font-semibold text-white">Manage Emails</h5>
                        <p>Go to the "Emails" section to merge contributor email addresses. This helps identify the same person across different email addresses.</p>
                    </div>
                </div>
                
                <div class="flex items-start gap-3">
                    <div class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">5</div>
                    <div>
                        <h5 class="font-semibold text-white">Associate People</h5>
                        <p>Visit the "People" section to link GitHub usernames with email addresses. This connects commit authors with their GitHub profiles.</p>
                    </div>
                </div>
                
                <div class="flex items-start gap-3">
                    <div class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold flex-shrink-0 mt-0.5">6</div>
                    <div>
                        <h5 class="font-semibold text-white">Analyze & View Reports</h5>
                        <p>Use "Analyze All" to calculate statistics, then visit "Reports" to see daily, weekly, monthly, and yearly analytics.</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-gray-700 rounded border border-gray-600">
                <h5 class="font-semibold text-white mb-2">üí° Pro Tips</h5>
                <ul class="space-y-1 text-xs">
                    <li>‚Ä¢ Use "Update All" to run fetch, analyze, and other operations in sequence</li>
                    <li>‚Ä¢ Individual repository buttons let you perform operations on specific repos</li>
                    <li>‚Ä¢ Failed jobs can be retried using the retry buttons</li>
                    <li>‚Ä¢ The page auto-refreshes when jobs are running to show progress</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Repositories Section -->
<div class="card mt-4">
    <div class="card-header">Repositories</div>
    <div class="card-body">
        {{if .Repositories}}
            <div class="space-y-4">
                {{range .Repositories}}
                <div class="p-4 border border-gray-600 rounded-lg bg-gray-800 bg-opacity-50" data-clone-url="{{.GitHubRepo.CloneURL}}" data-repo-name="{{.GitHubRepo.FullName}}" data-repository-id="{{.ProjectRepo.ID}}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <a href="/projects/{{$.Project.ID}}/repositories/{{.ProjectRepo.ID}}" class="text-sm font-mono font-semibold text-white hover:text-blue-300 transition-colors duration-200">{{.GitHubRepo.FullName}}</a>
                                <div class="flex gap-1">
                                    {{if .ProjectRepo.IsTracked}}
                                        <span class="text-xs bg-green-600 text-white px-2 py-1 rounded">Tracked</span>
                                    {{else}}
                                        <span class="text-xs bg-gray-600 text-white px-2 py-1 rounded">Untracked</span>
                                    {{end}}
                                    {{if .GitHubRepo.IsCloned}}
                                        <span class="text-xs bg-purple-600 text-white px-2 py-1 rounded">Cloned</span>
                                    {{end}}
                                    {{if .ProjectRepo.IsAnalyzed}}
                                        <span class="text-xs bg-orange-600 text-white px-2 py-1 rounded">Analyzed</span>
                                    {{end}}
                                </div>
                            </div>
                            {{if .GitHubRepo.Description}}
                                <p class="text-xs text-gray-300 mb-2">{{.GitHubRepo.Description}}</p>
                            {{end}}
                            <div class="space-y-1 text-xs text-gray-400">
                                {{if .GitHubRepo.IsCloned}}
                                    <p>Last cloned: {{.GitHubRepo.LastCloned.Format "2006-01-02 15:04:05"}}</p>
                                {{end}}
                                {{if .ProjectRepo.LastFetched}}
                                    <p>Last fetched: {{.ProjectRepo.LastFetched.Format "2006-01-02 15:04:05"}}</p>
                                {{else}}
                                    <p>Last fetched: never fetched</p>
                                {{end}}
                                <p>
                                    {{if .ProjectRepo.LastAnalyzed}}
                                        Last analyzed: {{.ProjectRepo.LastAnalyzed.Format "2006-01-02 15:04:05"}}
                                    {{else}}
                                        Last analyzed: never analyzed
                                    {{end}}
                                </p>
                            </div>
                        
                            <!-- Job Status Information -->
                            <div class="text-xs mt-2">
                                {{if .LatestCloneJobFailed}}
                                    <div class="text-red-400 bg-red-900 bg-opacity-20 px-2 py-1 rounded">‚ö†Ô∏è Clone job failed: {{.LatestCloneJobError}}</div>
                                {{end}}
                                {{if .LatestAnalyzeJobFailed}}
                                    <div class="text-red-400 bg-red-900 bg-opacity-20 px-2 py-1 rounded">‚ö†Ô∏è Analyze job failed: {{.LatestAnalyzeJobError}}</div>
                                {{end}}
                            </div>
                            
                            <!-- Failed Jobs Section -->
                            {{if .FailedJobs}}
                            <div class="mt-3 p-3 bg-red-900 bg-opacity-10 border border-red-600 rounded">
                                <div class="text-red-400 font-semibold mb-2 text-sm">Failed Jobs:</div>
                                {{range .FailedJobs}}
                                <div class="bg-red-900 bg-opacity-30 border border-red-500 rounded p-3 mb-2">
                                    <div class="flex justify-between items-start gap-3">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-red-400 font-mono text-sm font-semibold">{{.JobType}}</span>
                                                <span class="text-gray-400 text-xs">{{.CreatedAt.Format "2006-01-02 15:04:05"}}</span>
                                            </div>
                                            {{if .ErrorMessage}}
                                            <div class="text-red-300 text-xs leading-relaxed">{{.ErrorMessage}}</div>
                                            {{end}}
                                        </div>
                                        <button onclick="retryFailedJob('{{.ID}}')" 
                                                class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200 flex-shrink-0" title="Retry this failed job">
                                            Retry
                                        </button>
                                    </div>
                                </div>
                                {{end}}
                            </div>
                            {{end}}
                            <div class="flex gap-4 text-xs text-gray-400 mt-3">
                                <span class="flex items-center gap-1">‚≠ê {{.GitHubRepo.Stars}}</span>
                                <span class="flex items-center gap-1">üç¥ {{.GitHubRepo.Forks}}</span>
                                {{if .GitHubRepo.Language}}
                                    <span class="flex items-center gap-1">{{.GitHubRepo.Language}}</span>
                                {{end}}
                                {{if .GitHubRepo.Private}}
                                    <span class="flex items-center gap-1">üîí Private</span>
                                {{end}}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                        {{if .HasActiveJobs}}
                            <button disabled class="text-xs bg-yellow-600 text-white px-3 py-1 rounded cursor-not-allowed opacity-50" title="Repository is currently being processed ({{.ActiveJobType}})">
                                Processing...
                            </button>
                        {{else}}
                            {{if .ProjectRepo.IsTracked}}
                                {{if .HasActiveCloneJobs}}
                                    <button disabled class="text-xs bg-yellow-600 text-white px-3 py-1 rounded cursor-not-allowed opacity-50" title="Repository is currently being cloned">
                                        Cloning...
                                    </button>
                                {{else if .LatestCloneJobFailed}}
                                    <button onclick="retryFailedJob('{{.FailedCloneJobID}}')" 
                                            class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200" 
                                            title="Retry the last failed clone job">
                                        Retry Clone
                                    </button>
                                {{else}}
                                    <button onclick="cloneRepository('{{$.Project.ID}}', '{{.ProjectRepo.ID}}')" 
                                            class="text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200" title="{{if .GitHubRepo.IsCloned}}Pull latest changes from GitHub{{else}}Clone this repository to local storage{{end}}">
                                        {{if .GitHubRepo.IsCloned}}Pull Changes{{else}}Clone{{end}}
                                    </button>
                                {{end}}
                                
                                {{if .LatestAnalyzeJobFailed}}
                                    <button onclick="retryFailedJob('{{.FailedAnalyzeJobID}}')" 
                                            class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200" 
                                            title="Retry the last failed analyze job">
                                        Retry Analyze
                                    </button>
                                {{else}}
                                    <button onclick="fetchGithub('{{$.Project.ID}}', '{{.ProjectRepo.ID}}')" 
                                            class="text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200" title="Fetch latest pull requests and reviews from GitHub for this repository">
                                        Fetch Github
                                    </button>
                                    {{if and .HasCompletedPullRequestJobs .IsRepositoryCloned .HasGitHubPeopleWithEmails}}
                                        <button onclick="analyzeRepository('{{$.Project.ID}}', '{{.ProjectRepo.ID}}')" 
                                                class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200" title="Analyze this repository for statistics and insights">
                                            Analyze
                                        </button>
                                    {{else}}
                                        <button disabled class="text-xs bg-gray-600 text-gray-300 px-3 py-1 rounded cursor-not-allowed opacity-50" 
                                                title="{{if not .HasCompletedPullRequestJobs}}Fetch Github must be called first{{else if not .IsRepositoryCloned}}Repository must be cloned first{{else if not .HasGitHubPeopleWithEmails}}You need at least 1 GitHub account with an email associated to run analyze{{end}}">
                                            Analyze
                                        </button>
                                    {{end}}
                                {{end}}
                            {{end}}
                        {{end}}
                        
                        <button onclick="toggleTracking('{{$.Project.ID}}', '{{.ProjectRepo.ID}}', '{{if .ProjectRepo.IsTracked}}true{{else}}false{{end}}')" 
                                class="text-xs {{if .ProjectRepo.IsTracked}}bg-red-600 hover:bg-red-500{{else}}bg-green-600 hover:bg-green-500{{end}} text-white px-3 py-1 rounded transition-colors duration-200" title="{{if .ProjectRepo.IsTracked}}Stop tracking this repository{{else}}Start tracking this repository{{end}}">
                            {{if .ProjectRepo.IsTracked}}Untrack{{else}}Track{{end}}
                        </button>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
        {{else}}
            <p class="text-xs text-gray-400">No repositories found. Click "Fetch Repositories" to import your GitHub repositories.</p>
        {{end}}
    </div>
</div>

{{template "footer" .}}

<script>
// Toast functionality
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `p-3 rounded shadow-lg text-white text-sm max-w-sm transform transition-all duration-300 translate-x-full`;
    
    // Set background color based on type
    if (type === 'success') {
        toast.className += ' bg-green-500';
    } else if (type === 'error') {
        toast.className += ' bg-red-500';
    } else if (type === 'info') {
        toast.className += ' bg-blue-500';
    }

    toast.textContent = message;
    container.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);

    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (container.contains(toast)) {
                container.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Scroll position management
let scrollPosition = 0;

function saveScrollPosition() {
    scrollPosition = window.scrollY;
    // Also save to sessionStorage as backup
    sessionStorage.setItem('scrollPosition', scrollPosition.toString());
}

function restoreScrollPosition() {
    // Try to restore from sessionStorage first
    const savedPosition = sessionStorage.getItem('scrollPosition');
    if (savedPosition) {
        const position = parseInt(savedPosition, 10);
        if (position > 0) {
            window.scrollTo(0, position);
            // Clear the saved position after restoring
            sessionStorage.removeItem('scrollPosition');
            return;
        }
    }
    
    // Fallback to variable if sessionStorage is not available
    if (scrollPosition > 0) {
        window.scrollTo(0, scrollPosition);
    }
}

// Auto-refresh functionality for active jobs
function hasActiveJobs() {
    // Look for disabled buttons with yellow background (active job indicators)
    // Check for both the template-generated "Processing..." buttons and JavaScript-updated buttons
    const activeJobButtons = document.querySelectorAll('button[disabled].bg-yellow-600, button[disabled][style*="opacity"]');
    
    // Also check for buttons with "Processing...", "Cloning...", "Fetching...", or "Analyzing..." text
    const processingButtons = document.querySelectorAll('button[disabled]');
    let hasProcessingText = false;
    processingButtons.forEach(button => {
        const text = button.textContent.trim();
        if (text === 'Processing...' || text === 'Cloning...' || text === 'Fetching...' || text === 'Analyzing...') {
            hasProcessingText = true;
        }
    });
    
    return activeJobButtons.length > 0 || hasProcessingText;
}

function startAutoRefresh() {
    if (hasActiveJobs()) {
        console.log('Active jobs detected, starting auto-refresh every 5 seconds');
        setTimeout(function() {
            updateJobStatuses();
        }, 5000);
    }
}

function updateJobStatuses() {
    // Save current scroll position
    saveScrollPosition();
    
    console.log('Updating job statuses...');
    
    // Fetch updated job statuses via AJAX
    fetch(window.location.pathname + '?ajax=1', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('AJAX response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text();
    })
    .then(html => {
        console.log('AJAX response length:', html.length);
        console.log('AJAX response preview:', html.substring(0, 200));
        
        // Create a temporary div to parse the HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Update job status sections without full page reload
        updateJobSection(tempDiv);
        
        // Restore scroll position
        restoreScrollPosition();
        
        // Continue auto-refresh if there are still active jobs
        if (hasActiveJobs()) {
            setTimeout(updateJobStatuses, 5000);
        }
    })
    .catch(error => {
        console.error('Error updating job statuses:', error);
        // Don't reload the page on error, just log it
        // window.location.reload();
    });
}

function updateJobSection(newContent) {
    console.log('Updating job sections...');
    // Update repository status sections
    const repositorySections = document.querySelectorAll('[data-repository-id]');
    console.log('Found repository sections:', repositorySections.length);
    
    repositorySections.forEach(section => {
        const repoId = section.getAttribute('data-repository-id');
        const newSection = newContent.querySelector(`[data-repository-id="${repoId}"]`);
        if (newSection) {
            // Find the button container and replace it completely
            const buttonContainer = section.querySelector('.flex.flex-col.gap-2.ml-4');
            const newButtonContainer = newSection.querySelector('.flex.flex-col.gap-2.ml-4');
            
            if (buttonContainer && newButtonContainer) {
                console.log(`Repository ${repoId}: Replacing button container`);
                buttonContainer.innerHTML = newButtonContainer.innerHTML;
            }
            
            // Update failed jobs section
            const failedJobsSection = section.querySelector('.bg-red-900.bg-opacity-10');
            const newFailedJobsSection = newSection.querySelector('.bg-red-900.bg-opacity-10');
            
            if (failedJobsSection && newFailedJobsSection) {
                // Update the entire failed jobs section
                failedJobsSection.innerHTML = newFailedJobsSection.innerHTML;
                console.log(`Updated failed jobs section for repository ${repoId}`);
            } else if (failedJobsSection && !newFailedJobsSection) {
                // Remove failed jobs section if there are no more failed jobs
                failedJobsSection.remove();
                console.log(`Removed failed jobs section for repository ${repoId}`);
            } else if (!failedJobsSection && newFailedJobsSection) {
                // Add failed jobs section if there are new failed jobs
                // Find the right place to insert it (before the stats section)
                const statsSection = section.querySelector('.flex.gap-4.text-xs.text-gray-400');
                if (statsSection) {
                    statsSection.parentNode.insertBefore(newFailedJobsSection.cloneNode(true), statsSection);
                    console.log(`Added failed jobs section for repository ${repoId}`);
                }
            }
            
            // Update job status information (error messages)
            const jobStatusInfo = section.querySelector('.text-xs.mt-2');
            const newJobStatusInfo = newSection.querySelector('.text-xs.mt-2');
            
            if (jobStatusInfo && newJobStatusInfo) {
                jobStatusInfo.innerHTML = newJobStatusInfo.innerHTML;
                console.log(`Updated job status info for repository ${repoId}`);
            }
            
        } else {
            console.log(`No matching section found for repository ${repoId}`);
        }
    });
}

// Help section toggle functionality
function toggleHelpSection() {
    const helpContent = document.getElementById('help-content');
    const helpToggle = document.getElementById('help-toggle');
    const isHidden = helpContent.classList.contains('hidden');
    
    if (isHidden) {
        helpContent.classList.remove('hidden');
        helpToggle.textContent = '‚ñ≤';
        localStorage.setItem('gscope-help-collapsed', 'false');
    } else {
        helpContent.classList.add('hidden');
        helpToggle.textContent = '‚ñº';
        localStorage.setItem('gscope-help-collapsed', 'true');
    }
}

// Start auto-refresh when page loads if there are active jobs
document.addEventListener('DOMContentLoaded', function() {
    // Show toast if there's a message in URL params
    const urlParams = new URLSearchParams(window.location.search);
    const message = urlParams.get('message');
    if (message) {
        showToast(message, 'success');
        // Clean up URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    // Restore scroll position if it was saved
    restoreScrollPosition();
    
    // Restore help section state from localStorage
    const helpCollapsed = localStorage.getItem('gscope-help-collapsed');
    if (helpCollapsed === 'true') {
        const helpContent = document.getElementById('help-content');
        const helpToggle = document.getElementById('help-toggle');
        if (helpContent && helpToggle) {
            helpContent.classList.add('hidden');
            helpToggle.textContent = '‚ñº';
        }
    }
    
    // Start auto-refresh
    startAutoRefresh();
});

// AJAX functions for clone and track operations
function cloneRepository(projectId, repositoryId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    // Find the repository section and disable all buttons
    const repositorySection = event.target.closest('[data-repository-id]');
    if (repositorySection) {
        const allButtons = repositorySection.querySelectorAll('button');
        allButtons.forEach(btn => {
            btn.disabled = true;
            btn.className = 'text-xs bg-yellow-600 text-white px-3 py-1 rounded cursor-not-allowed opacity-50';
        });
        
        // Update the clicked button text
        const button = event.target;
        button.textContent = 'Cloning...';
    }
    
    fetch(`/projects/${projectId}/repositories/${repositoryId}/clone`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Clone job created successfully', 'success');
            // Start auto-refresh instead of immediate reload
            startAutoRefresh();
        } else {
            // Restore all button states on error
            if (repositorySection) {
                const allButtons = repositorySection.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    // Restore original classes based on button type
                    if (btn.textContent.includes('Clone') || btn.textContent.includes('Pull')) {
                        btn.className = 'text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Fetch')) {
                        btn.className = 'text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Analyze')) {
                        btn.className = 'text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Track') || btn.textContent.includes('Untrack')) {
                        btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    }
                });
            }
            showToast(data.message || 'Failed to create clone job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Restore all button states on error
        if (repositorySection) {
            const allButtons = repositorySection.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.disabled = false;
                // Restore original classes based on button type
                if (btn.textContent.includes('Clone') || btn.textContent.includes('Pull')) {
                    btn.className = 'text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Fetch')) {
                    btn.className = 'text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Analyze')) {
                    btn.className = 'text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Track') || btn.textContent.includes('Untrack')) {
                    btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                }
            });
        }
        showToast('Failed to create clone job', 'error');
    });
}

function toggleTracking(projectId, repositoryId, currentStatus) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    const isTracked = currentStatus === 'true';
    fetch(`/projects/${projectId}/repositories/${repositoryId}/toggle-track`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || `Repository ${isTracked ? 'untracked' : 'tracked'} successfully`, 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to update tracking status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to update tracking status', 'error');
    });
}

function fetchGithub(projectId, repositoryId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    // Find the repository section and disable all buttons
    const repositorySection = event.target.closest('[data-repository-id]');
    if (repositorySection) {
        const allButtons = repositorySection.querySelectorAll('button');
        allButtons.forEach(btn => {
            btn.disabled = true;
            btn.className = 'text-xs bg-yellow-600 text-white px-3 py-1 rounded cursor-not-allowed opacity-50';
        });
        
        // Update the clicked button text
        const button = event.target;
        button.textContent = 'Fetching...';
    }
    
    fetch(`/projects/${projectId}/repositories/${repositoryId}/fetch-github`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Fetch Github job created successfully', 'success');
            // Start auto-refresh instead of immediate reload
            startAutoRefresh();
        } else {
            // Restore all button states on error
            if (repositorySection) {
                const allButtons = repositorySection.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    // Restore original classes based on button type
                    if (btn.textContent.includes('Clone') || btn.textContent.includes('Pull')) {
                        btn.className = 'text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Fetch')) {
                        btn.className = 'text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Analyze')) {
                        btn.className = 'text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Track') || btn.textContent.includes('Untrack')) {
                        btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    }
                });
            }
            showToast(data.message || 'Failed to create fetch Github job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Restore all button states on error
        if (repositorySection) {
            const allButtons = repositorySection.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.disabled = false;
                // Restore original classes based on button type
                if (btn.textContent.includes('Clone') || btn.textContent.includes('Pull')) {
                    btn.className = 'text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Fetch')) {
                    btn.className = 'text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Analyze')) {
                    btn.className = 'text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Track') || btn.textContent.includes('Untrack')) {
                    btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                }
            });
        }
        showToast('Failed to create fetch Github job', 'error');
    });
}

function analyzeRepository(projectId, repositoryId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    // Find the repository section and disable all buttons
    const repositorySection = event.target.closest('[data-repository-id]');
    if (repositorySection) {
        const allButtons = repositorySection.querySelectorAll('button');
        allButtons.forEach(btn => {
            btn.disabled = true;
            btn.className = 'text-xs bg-yellow-600 text-white px-3 py-1 rounded cursor-not-allowed opacity-50';
        });
        
        // Update the clicked button text
        const button = event.target;
        button.textContent = 'Analyzing...';
    }
    
    fetch(`/projects/${projectId}/repositories/${repositoryId}/analyze`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Analysis job created successfully', 'success');
            // Start auto-refresh instead of immediate reload
            startAutoRefresh();
        } else {
            // Restore all button states on error
            if (repositorySection) {
                const allButtons = repositorySection.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    // Restore original classes based on button type
                    if (btn.textContent.includes('Clone') || btn.textContent.includes('Pull')) {
                        btn.className = 'text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Fetch')) {
                        btn.className = 'text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Analyze')) {
                        btn.className = 'text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Track') || btn.textContent.includes('Untrack')) {
                        btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    }
                });
            }
            showToast(data.message || 'Failed to create analysis job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Restore all button states on error
        if (repositorySection) {
            const allButtons = repositorySection.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.disabled = false;
                // Restore original classes based on button type
                if (btn.textContent.includes('Clone') || btn.textContent.includes('Pull')) {
                    btn.className = 'text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Fetch')) {
                    btn.className = 'text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Analyze')) {
                    btn.className = 'text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Track') || btn.textContent.includes('Untrack')) {
                    btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                }
            });
        }
        showToast('Failed to create analysis job', 'error');
    });
}

// Legacy function for copying clone URLs (kept for compatibility)
function copyCloneUrl(cloneUrl, repoName) {
    // Copy clone URL to clipboard
    navigator.clipboard.writeText(cloneUrl).then(function() {
        alert('Clone URL copied to clipboard for: ' + repoName + '\n\nURL: ' + cloneUrl);
    }).catch(function(err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = cloneUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Clone URL copied to clipboard for: ' + repoName + '\n\nURL: ' + cloneUrl);
    });
}

function trackAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/track-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'All repositories tracked successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to track all repositories', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to track all repositories', 'error');
    });
}

function cloneAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/clone-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Clone jobs created successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to create clone jobs', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to create clone jobs', 'error');
    });
}

function fetchAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/fetch-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Fetch jobs created successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to create fetch jobs', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to create fetch jobs', 'error');
    });
}

function analyzeAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/analyze-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (response.redirected) {
            // If the response is a redirect, follow it
            window.location.href = response.url;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.success) {
            showToast(data.message || 'Analyze jobs created successfully', 'success');
            // Start auto-refresh instead of immediate reload
            startAutoRefresh();
        } else if (data) {
            showToast(data.message || 'Failed to create analyze jobs', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to create analyze jobs', 'error');
    });
}

function updateAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/update-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (response.redirected) {
            // If the response is a redirect, follow it
            window.location.href = response.url;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.success) {
            showToast(data.message || 'Update jobs created successfully', 'success');
            // Start auto-refresh instead of immediate reload
            startAutoRefresh();
        } else if (data) {
            showToast(data.message || 'Failed to create update jobs', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to create update jobs', 'error');
    });
}

// General retry function for any failed job
function retryFailedJob(jobId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    // Find the repository section and disable all buttons
    const repositorySection = event.target.closest('[data-repository-id]');
    if (repositorySection) {
        const allButtons = repositorySection.querySelectorAll('button');
        allButtons.forEach(btn => {
            btn.disabled = true;
            btn.className = 'text-xs bg-yellow-600 text-white px-3 py-1 rounded cursor-not-allowed opacity-50';
        });
    }
    
    // Find the button that was clicked and update its text
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Retrying...';
    
    fetch(`/projects/jobs/${jobId}/retry`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (response.redirected) {
            // If the response is a redirect, follow it
            window.location.href = response.url;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.success) {
            showToast(data.message || 'Retry job created successfully', 'success');
            // Change button to processing state since the job is now active
            button.disabled = true;
            button.textContent = 'Processing...';
            button.className = 'text-xs bg-yellow-600 text-white px-3 py-1 rounded cursor-not-allowed opacity-50';
            // Start auto-refresh instead of immediate reload
            startAutoRefresh();
        } else if (data) {
            // Restore all button states on error
            if (repositorySection) {
                const allButtons = repositorySection.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = false;
                    // Restore original classes based on button type
                    if (btn.textContent.includes('Clone') || btn.textContent.includes('Pull')) {
                        btn.className = 'text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Fetch')) {
                        btn.className = 'text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Analyze')) {
                        btn.className = 'text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Track') || btn.textContent.includes('Untrack')) {
                        btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    } else if (btn.textContent.includes('Retry')) {
                        btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                    }
                });
            }
            showToast(data.message || 'Failed to create retry job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Restore all button states on error
        if (repositorySection) {
            const allButtons = repositorySection.querySelectorAll('button');
            allButtons.forEach(btn => {
                btn.disabled = false;
                // Restore original classes based on button type
                if (btn.textContent.includes('Clone') || btn.textContent.includes('Pull')) {
                    btn.className = 'text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Fetch')) {
                    btn.className = 'text-xs bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Analyze')) {
                    btn.className = 'text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Track') || btn.textContent.includes('Untrack')) {
                    btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                } else if (btn.textContent.includes('Retry')) {
                    btn.className = 'text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded transition-colors duration-200';
                }
            });
        }
        showToast('Failed to create retry job', 'error');
    });
}
</script>
{{end}} 