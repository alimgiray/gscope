{{define "project_view"}}
{{template "header" .}}

<div class="card">
    <div class="flex justify-between items-center">
        <div class="card-header">{{.Project.Name}}</div>
        <a href="/projects/{{.Project.ID}}/settings" class="text-green-400 hover:text-green-300 text-xs">‚öô Settings</a>
    </div>
    {{if .Project.Description}}
    <p>{{.Project.Description}}</p>
    {{end}}
    <div class="text-xs text-gray-400 mt-2">
        Created: {{.Project.CreatedAt.Format "2006-01-02 15:04:05"}}
    </div>
    <div id="auto-refresh-indicator" class="mt-4 p-2 bg-blue-100 border border-blue-400 text-blue-700 rounded text-xs hidden">
        üîÑ Auto-refreshing every 5 seconds to show job progress...
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    <div class="mt-4 flex gap-2">
        <form method="POST" action="/projects/{{.Project.ID}}/fetch-repositories" class="inline">
            <button type="submit" class="btn" style="background: #059669; color: white;">Fetch Repositories</button>
        </form>
        <button class="btn" style="background: #f59e0b; color: white;" onclick="trackAllRepositories('{{.Project.ID}}')">
            Track All
        </button>
        <button class="btn" style="background: #7c3aed; color: white;" onclick="cloneAllRepositories('{{.Project.ID}}')">
            Clone All
        </button>
        <button class="btn" style="background: #10b981; color: white;" onclick="fetchAllRepositories('{{.Project.ID}}')">
            Fetch Github All
        </button>
        <button class="btn" style="background: #3b82f6; color: white;" onclick="analyzeAllRepositories('{{.Project.ID}}')">
            Analyze All
        </button>
        <a href="/projects/{{.Project.ID}}/emails" class="btn" style="background: #dc2626; color: white;">Emails</a>
        <a href="/projects/{{.Project.ID}}/people" class="btn" style="background: #2563eb; color: white;">People</a>
    </div>
</div>

<!-- Repositories Section -->
<div class="card mt-4">
    <div class="card-header">Repositories</div>
    <div class="card-body">
        {{if .Repositories}}
            <div class="space-y-2">
                {{range .Repositories}}
                <div class="flex justify-between items-center p-2 border border-gray-600 rounded" data-clone-url="{{.GitHubRepo.CloneURL}}" data-repo-name="{{.GitHubRepo.FullName}}">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-mono">{{.GitHubRepo.FullName}}</span>
                            {{if .ProjectRepo.IsTracked}}
                                <span class="text-xs bg-green-600 text-white px-1 rounded">Tracked</span>
                            {{else}}
                                <span class="text-xs bg-gray-600 text-white px-1 rounded">Untracked</span>
                            {{end}}
                            {{if .GitHubRepo.IsCloned}}
                                <span class="text-xs bg-purple-600 text-white px-1 rounded">Cloned</span>
                            {{end}}
                            {{if .ProjectRepo.IsAnalyzed}}
                                <span class="text-xs bg-orange-600 text-white px-1 rounded">Analyzed</span>
                            {{end}}
                        </div>
                        {{if .GitHubRepo.Description}}
                            <p class="text-xs text-gray-400 mt-1">{{.GitHubRepo.Description}}</p>
                        {{end}}
                        {{if .GitHubRepo.IsCloned}}
                            <p class="text-xs text-gray-400 mt-1">Last cloned: {{.GitHubRepo.LastCloned.Format "2006-01-02 15:04:05"}}</p>
                        {{end}}
                        <p class="text-xs text-gray-400 mt-1">
                            {{if .ProjectRepo.LastAnalyzed}}
                                Last analyzed: {{.ProjectRepo.LastAnalyzed.Format "2006-01-02 15:04:05"}}
                            {{else}}
                                Last analyzed: never analyzed
                            {{end}}
                        </p>
                        <div class="flex gap-4 text-xs text-gray-400 mt-1">
                            <span>‚≠ê {{.GitHubRepo.Stars}}</span>
                            <span>üç¥ {{.GitHubRepo.Forks}}</span>
                            {{if .GitHubRepo.Language}}
                                <span>{{.GitHubRepo.Language}}</span>
                            {{end}}
                            {{if .GitHubRepo.Private}}
                                <span>üîí Private</span>
                            {{end}}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        {{if .ProjectRepo.IsTracked}}
                            {{if .HasActiveCloneJobs}}
                                <button disabled class="text-xs text-yellow-400 cursor-not-allowed">
                                    Cloning...
                                </button>
                            {{else if .LatestCloneJobFailed}}
                                <button onclick="cloneRepository('{{$.Project.ID}}', '{{.ProjectRepo.ID}}')" class="text-xs text-red-400 hover:text-red-300" title="Last attempt failed: {{.LatestCloneJobError}}">
                                    Retry Clone
                                </button>
                            {{else}}
                                <button onclick="cloneRepository('{{$.Project.ID}}', '{{.ProjectRepo.ID}}')" class="text-xs text-purple-400 hover:text-purple-300">
                                    {{if .GitHubRepo.IsCloned}}Pull Changes{{else}}Clone{{end}}
                                </button>
                            {{end}}
                        {{end}}
                        {{if .ProjectRepo.IsTracked}}
                            {{if .HasActiveAnalyzeJobs}}
                                <button disabled class="text-xs text-yellow-400 cursor-not-allowed">
                                    Processing...
                                </button>
                            {{else if .LatestAnalyzeJobFailed}}
                                <button onclick="analyzeRepository('{{$.Project.ID}}', '{{.ProjectRepo.ID}}')" class="text-xs text-red-400 hover:text-red-300" title="Last attempt failed: {{.LatestAnalyzeJobError}}">
                                    Retry Analyze
                                </button>
                            {{else}}
                                <button onclick="fetchGithub('{{$.Project.ID}}', '{{.ProjectRepo.ID}}')" class="text-xs text-green-400 hover:text-green-300">
                                    Fetch Github
                                </button>
                                {{if and .HasCompletedPullRequestJobs .IsRepositoryCloned .HasGitHubPeopleWithEmails}}
                                    <button onclick="analyzeRepository('{{$.Project.ID}}', '{{.ProjectRepo.ID}}')" class="text-xs text-blue-400 hover:text-blue-300">
                                        Analyze
                                    </button>
                                {{else}}
                                    <button disabled class="text-xs text-gray-400 cursor-not-allowed" title="{{if not .HasCompletedPullRequestJobs}}Fetch Github must be called first{{else if not .IsRepositoryCloned}}Repository must be cloned first{{else if not .HasGitHubPeopleWithEmails}}You need at least 1 GitHub account with an email associated to run analyze{{end}}">
                                        Analyze
                                    </button>
                                {{end}}
                            {{end}}
                        {{end}}
                        <button onclick="toggleTracking('{{$.Project.ID}}', '{{.ProjectRepo.ID}}', '{{if .ProjectRepo.IsTracked}}true{{else}}false{{end}}')" class="text-xs {{if .ProjectRepo.IsTracked}}text-red-400 hover:text-red-300{{else}}text-green-400 hover:text-green-300{{end}}">
                            {{if .ProjectRepo.IsTracked}}Untrack{{else}}Track{{end}}
                        </button>
                    </div>
                </div>
                {{end}}
            </div>
        {{else}}
            <p class="text-xs text-gray-400">No repositories found. Click "Fetch Repositories" to import your GitHub repositories.</p>
        {{end}}
    </div>
</div>

{{template "footer" .}}

<script>
// Toast functionality
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `p-3 rounded shadow-lg text-white text-sm max-w-sm transform transition-all duration-300 translate-x-full`;
    
    // Set background color based on type
    if (type === 'success') {
        toast.className += ' bg-green-500';
    } else if (type === 'error') {
        toast.className += ' bg-red-500';
    } else if (type === 'info') {
        toast.className += ' bg-blue-500';
    }

    toast.textContent = message;
    container.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);

    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (container.contains(toast)) {
                container.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Scroll position management
let scrollPosition = 0;

function saveScrollPosition() {
    scrollPosition = window.scrollY;
    // Also save to sessionStorage as backup
    sessionStorage.setItem('scrollPosition', scrollPosition.toString());
}

function restoreScrollPosition() {
    // Try to restore from sessionStorage first
    const savedPosition = sessionStorage.getItem('scrollPosition');
    if (savedPosition) {
        const position = parseInt(savedPosition, 10);
        if (position > 0) {
            window.scrollTo(0, position);
            // Clear the saved position after restoring
            sessionStorage.removeItem('scrollPosition');
            return;
        }
    }
    
    // Fallback to variable if sessionStorage is not available
    if (scrollPosition > 0) {
        window.scrollTo(0, scrollPosition);
    }
}

// Auto-refresh functionality for active jobs
function hasActiveJobs() {
    const activeJobButtons = document.querySelectorAll('button[disabled].text-yellow-400');
    return activeJobButtons.length > 0;
}

function showAutoRefreshIndicator() {
    const indicator = document.getElementById('auto-refresh-indicator');
    if (indicator) {
        indicator.classList.remove('hidden');
    }
}

function startAutoRefresh() {
    if (hasActiveJobs()) {
        console.log('Active jobs detected, starting auto-refresh every 5 seconds');
        showAutoRefreshIndicator();
        setTimeout(function() {
            saveScrollPosition();
            window.location.reload();
        }, 5000);
    }
}

// Start auto-refresh when page loads if there are active jobs
document.addEventListener('DOMContentLoaded', function() {
    // Show toast if there's a message in URL params
    const urlParams = new URLSearchParams(window.location.search);
    const message = urlParams.get('message');
    if (message) {
        showToast(message, 'success');
        // Clean up URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    // Restore scroll position if it was saved
    restoreScrollPosition();
    
    // Start auto-refresh
    startAutoRefresh();
});

// AJAX functions for clone and track operations
function cloneRepository(projectId, repositoryId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    // Find the button that was clicked and disable it immediately
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Cloning...';
    button.className = 'text-xs text-yellow-400 cursor-not-allowed';
    
    fetch(`/projects/${projectId}/repositories/${repositoryId}/clone`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Clone job created successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            // Restore button state on error
            button.disabled = false;
            button.textContent = originalText;
            button.className = 'text-xs text-purple-400 hover:text-purple-300';
            showToast(data.message || 'Failed to create clone job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Restore button state on error
        button.disabled = false;
        button.textContent = originalText;
        button.className = 'text-xs text-purple-400 hover:text-purple-300';
        showToast('Failed to create clone job', 'error');
    });
}

function toggleTracking(projectId, repositoryId, currentStatus) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    const isTracked = currentStatus === 'true';
    fetch(`/projects/${projectId}/repositories/${repositoryId}/toggle-track`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || `Repository ${isTracked ? 'untracked' : 'tracked'} successfully`, 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to update tracking status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to update tracking status', 'error');
    });
}

function fetchGithub(projectId, repositoryId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    // Find the button that was clicked and disable it immediately
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Fetching...';
    button.className = 'text-xs text-yellow-400 cursor-not-allowed';
    
    fetch(`/projects/${projectId}/repositories/${repositoryId}/fetch-github`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Fetch Github job created successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            // Restore button state on error
            button.disabled = false;
            button.textContent = originalText;
            button.className = 'text-xs text-green-400 hover:text-green-300';
            showToast(data.message || 'Failed to create fetch Github job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Restore button state on error
        button.disabled = false;
        button.textContent = originalText;
        button.className = 'text-xs text-green-400 hover:text-green-300';
        showToast('Failed to create fetch Github job', 'error');
    });
}

function analyzeRepository(projectId, repositoryId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    // Find the button that was clicked and disable it immediately
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Analyzing...';
    button.className = 'text-xs text-yellow-400 cursor-not-allowed';
    
    fetch(`/projects/${projectId}/repositories/${repositoryId}/analyze`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Analysis job created successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            // Restore button state on error
            button.disabled = false;
            button.textContent = originalText;
            button.className = 'text-xs text-blue-400 hover:text-blue-300';
            showToast(data.message || 'Failed to create analysis job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Restore button state on error
        button.disabled = false;
        button.textContent = originalText;
        button.className = 'text-xs text-blue-400 hover:text-blue-300';
        showToast('Failed to create analysis job', 'error');
    });
}

// Legacy function for copying clone URLs (kept for compatibility)
function copyCloneUrl(cloneUrl, repoName) {
    // Copy clone URL to clipboard
    navigator.clipboard.writeText(cloneUrl).then(function() {
        alert('Clone URL copied to clipboard for: ' + repoName + '\n\nURL: ' + cloneUrl);
    }).catch(function(err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = cloneUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Clone URL copied to clipboard for: ' + repoName + '\n\nURL: ' + cloneUrl);
    });
}

function trackAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/track-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'All repositories tracked successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to track all repositories', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to track all repositories', 'error');
    });
}

function cloneAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/clone-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Clone jobs created successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to create clone jobs', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to create clone jobs', 'error');
    });
}

function fetchAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/fetch-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Fetch jobs created successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to create fetch jobs', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to create fetch jobs', 'error');
    });
}

function analyzeAllRepositories(projectId) {
    // Prevent any default behavior that might cause scroll jump
    event.preventDefault();
    
    fetch(`/projects/${projectId}/analyze-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Analyze jobs created successfully', 'success');
            // Refresh the page after a short delay to show updated status
            setTimeout(() => {
                saveScrollPosition();
                window.location.reload();
            }, 100);
        } else {
            showToast(data.message || 'Failed to create analyze jobs', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to create analyze jobs', 'error');
    });
}
</script>
{{end}} 