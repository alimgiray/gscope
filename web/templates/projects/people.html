{{define "project_people"}}
{{template "header" .}}

<div class="card">
    <div class="flex justify-between items-center">
        <div class="card-header">People - {{.Project.Name}}</div>
        <a href="/projects/{{.Project.ID}}" class="text-green-400 hover:text-green-300 text-xs">‚Üê Back to Project</a>
    </div>
    <div class="text-xs text-gray-400 mt-2">
        All GitHub people found in this project. Associate emails to connect commits with pull requests.
    </div>
</div>

<!-- People Section -->
<div class="card mt-4">
    <div class="card-header">GitHub People</div>
    <div class="card-body">
        {{if .People}}
            <div class="space-y-2">
                {{range .People}}
                <div class="flex justify-between items-center p-2 border border-gray-600 rounded">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            {{if .AvatarURL}}
                                <img src="{{.AvatarURL}}" alt="{{.Username}}" class="w-6 h-6 rounded-full">
                            {{end}}
                            <span class="text-sm font-mono">{{.Username}}</span>
                            {{if .DisplayName}}
                                <span class="text-xs text-gray-400">({{.DisplayName}})</span>
                            {{end}}
                            {{if .Type}}
                                <span class="text-xs bg-gray-600 text-white px-1 rounded">{{.Type}}</span>
                            {{end}}
                        </div>
                        {{if .ProfileURL}}
                            <div class="text-xs text-gray-400 mt-1">
                                <a href="{{.ProfileURL}}" target="_blank" class="text-blue-400 hover:text-blue-300">View Profile</a>
                            </div>
                        {{end}}
                        <div class="text-xs text-gray-400 mt-1">
                            GitHub ID: {{.GithubUserID}}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            Added: {{.CreatedAt.Format "2006-01-02 15:04:05"}}
                        </div>
                        
                        <!-- Email Association Section -->
                        {{$associatedEmail := index $.PersonEmailMap .ID}}
                        {{if $associatedEmail}}
                            <div class="text-xs text-green-400 mt-2">
                                <span class="font-mono">Associated Email: {{$associatedEmail}}</span>
                                <button onclick="detachEmail('{{$.Project.ID}}', '{{$associatedEmail}}')" class="text-xs bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded ml-2">
                                    Detach
                                </button>
                            </div>
                        {{else}}
                            <div class="text-xs text-gray-400 mt-2">
                                <span>No email associated</span>
                            </div>
                        {{end}}
                    </div>
                    
                    <!-- Email Association Controls -->
                    {{if not $associatedEmail}}
                    <div class="flex items-center gap-2">
                        <select class="text-xs bg-gray-800 border border-gray-600 rounded px-2 py-1" onchange="updateEmailTarget('{{.ID}}', this.value)">
                            <option value="">Select email to associate...</option>
                            {{$sortedEmails := index $.PersonSortedEmails .ID}}
                            {{range $sortedEmails}}
                                {{if not (index $.AssociatedEmails .)}}
                                    <option value="{{.}}">{{.}}</option>
                                {{end}}
                            {{end}}
                        </select>
                        <button onclick="associateEmail('{{$.Project.ID}}', '{{.ID}}')" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded" disabled id="associate-btn-{{.ID}}">
                            Associate
                        </button>
                    </div>
                    {{end}}
                </div>
                {{end}}
            </div>
        {{else}}
            <p class="text-xs text-gray-400">No people found. Analyze pull requests to discover GitHub people.</p>
        {{end}}
    </div>
</div>

<script>
let emailTargets = {};

function updateEmailTarget(githubPersonId, email) {
    emailTargets[githubPersonId] = email;
    const associateBtn = document.getElementById('associate-btn-' + githubPersonId);
    if (associateBtn) {
        associateBtn.disabled = !email;
    }
}

function associateEmail(projectId, githubPersonId) {
    const email = emailTargets[githubPersonId];
    if (!email) {
        alert('Please select an email first');
        return;
    }

    const formData = new FormData();
    formData.append('github_person_id', githubPersonId);
    formData.append('email', email);

    fetch(`/projects/${projectId}/people/associate`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated associations
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to associate email');
    });
}

function detachEmail(projectId, email) {
    if (!confirm(`Are you sure you want to detach ${email}?`)) {
        return;
    }

    const formData = new FormData();
    formData.append('email', email);

    fetch(`/projects/${projectId}/people/detach`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated associations
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to detach email');
    });
}
</script>

{{template "footer" .}}
{{end}} 